name: Build Password Board

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create release with artifacts'
        required: false
        type: boolean
        default: false

jobs:
  extract-version:
    name: Extract Version
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag or pubspec.yaml
      id: get_version
      run: |
        # Check if triggered by tag
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Using tag version: $VERSION"
        else
          VERSION=$(sed -n 's/^version: \([0-9]*\.[0-9]*\.[0-9]*\).*/\1/p' pubspec.yaml)
          echo "Using pubspec version: $VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Final version: $VERSION"

  build-linux:
    name: Build Linux
    needs: extract-version
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'
        cache: true

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives/*.deb
          /var/lib/apt/lists/*
        key: linux-apt-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          linux-apt-

    - name: Install Linux dependencies
      run: |
        sudo apt-get update --quiet
        sudo apt-get install -y --no-install-recommends \
          clang \
          cmake \
          ninja-build \
          pkg-config \
          libgtk-3-dev \
          libblkid-dev \
          liblzma-dev

    - name: Enable Linux desktop
      run: flutter config --enable-linux-desktop

    - name: Install dependencies
      run: |
        echo "Installing Flutter dependencies..."
        flutter pub get --verbose

    - name: Build Linux release
      run: |
        echo "Starting Flutter build..."
        time flutter build linux --release --build-name=${{ needs.extract-version.outputs.version }} --build-number=1
      timeout-minutes: 20
      env:
        FLUTTER_BUILD_MODE: release

    - name: Create Linux archive
      run: |
        echo "Checking build directory structure..."
        ls -la build/linux/x64/release/ || echo "Build directory not found"
        if [ -d "build/linux/x64/release/bundle" ]; then
          echo "Creating Linux archive..."
          cd build/linux/x64/release/bundle
          echo "Bundle size before compression:"
          du -sh .
          tar -czf "${GITHUB_WORKSPACE}/password_board_linux.tar.gz" --exclude="*.debug" --exclude="*.sym" .
          echo "Archive created successfully"
          ls -lh "${GITHUB_WORKSPACE}/password_board_linux.tar.gz"
        else
          echo "Linux bundle directory not found, checking alternatives..."
          find build/linux/ -name "*" -type d | grep -i release || echo "No release directories found"
          echo "Error: Linux build directory not found"
          exit 1
        fi

    - name: Upload Linux build
      uses: actions/upload-artifact@v4
      with:
        name: password-board-linux
        path: password_board_linux.tar.gz
        retention-days: 30

  build-windows:
    name: Build Windows
    needs: extract-version
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'
        cache: true

    - name: Cache Windows dependencies
      uses: actions/cache@v4
      with:
        path: |
          C:\Users\runneradmin\.flutter-tool-cache
          C:\Users\runneradmin\AppData\Local\Pub\Cache
        key: windows-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          windows-flutter-pub-

    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop

    - name: Install dependencies
      run: |
        echo "Installing Flutter dependencies..."
        flutter pub get

    - name: Build Windows release
      run: |
        echo "Starting Flutter Windows build..."
        flutter build windows --release --build-name=${{ needs.extract-version.outputs.version }} --build-number=1
      timeout-minutes: 15

    - name: Create Windows archive
      run: |
        echo "Checking Windows build directory structure..."
        Get-ChildItem build/windows/x64/runner/ -ErrorAction SilentlyContinue || echo "Build directory not found"
        if (Test-Path "build/windows/x64/runner/Release") {
          cd build/windows/x64/runner/Release
          echo "Files in Release directory:"
          Get-ChildItem -Recurse | Select-Object FullName, Length | Format-Table -AutoSize

          # Check if there are multiple files or just an exe
          $exeFiles = Get-ChildItem -Filter "*.exe" -Recurse
          $allFiles = Get-ChildItem -Recurse -File

          if ($exeFiles.Count -eq 1 -and $allFiles.Count -eq 1) {
            echo "Only single .exe file found - uploading directly"
            Copy-Item $exeFiles[0].FullName "${env:GITHUB_WORKSPACE}/password_board_windows.exe"
            echo "EXE copied successfully"
            Get-Item "${env:GITHUB_WORKSPACE}/password_board_windows.exe"
          } else {
            echo "Multiple files found - creating zip archive"
            Compress-Archive -Path . -DestinationPath "${env:GITHUB_WORKSPACE}/password_board_windows.zip" -Force
            echo "Archive created successfully"
            Get-Item "${env:GITHUB_WORKSPACE}/password_board_windows.zip"
          }
        } else {
          echo "Windows Release directory not found, checking alternatives..."
          Get-ChildItem build/windows/ -Recurse -Directory | Where-Object { $_.Name -like "*Release*" -or $_.Name -like "*release*" }
          echo "Error: Windows build directory not found"
          exit 1
        }

    - name: Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: password-board-windows
        path: password_board_windows.*
        retention-days: 30

  build-macos:
    name: Build macOS
    needs: extract-version
    runs-on: macos-13

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.2'
        channel: 'stable'
        cache: true

    - name: Cache macOS dependencies
      uses: actions/cache@v4
      with:
        path: |
          /Users/runner/Library/Caches/flutter
          /Users/runner/.pub-cache
        key: macos-flutter-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          macos-flutter-pub-

    - name: Enable macOS desktop
      run: flutter config --enable-macos-desktop

    - name: Install dependencies
      run: |
        echo "Installing Flutter dependencies..."
        flutter pub get

    - name: Build macOS release
      run: |
        echo "Starting Flutter macOS build..."
        flutter build macos --release --build-name=${{ needs.extract-version.outputs.version }} --build-number=1
      timeout-minutes: 15

    - name: Create macOS archive
      run: |
        echo "Checking macOS build directory structure..."
        ls -la build/macos/Build/Products/ || echo "Build directory not found"
        if [ -d "build/macos/Build/Products/Release" ]; then
          echo "Creating macOS archive..."
          cd build/macos/Build/Products/Release
          ls -la *.app || echo "No .app files found"

          # Find the actual app name
          APP_NAME=$(ls -d *.app 2>/dev/null | head -n1)
          if [ -n "$APP_NAME" ]; then
            echo "Found app: $APP_NAME"
            # Create archive in repository root
            zip -r "${GITHUB_WORKSPACE}/password_board_macos.zip" "$APP_NAME"
            echo "Archive created successfully"
            ls -la "${GITHUB_WORKSPACE}/password_board_macos.zip"
          else
            echo "Error: No .app files found in Release directory"
            ls -la
            exit 1
          fi
        else
          echo "Error: macOS build directory not found"
          exit 1
        fi

    - name: Upload macOS build
      uses: actions/upload-artifact@v4
      with:
        name: password-board-macos
        path: password_board_macos.zip
        retention-days: 30





  release:
    name: Create Release
    needs: [extract-version, build-linux, build-windows, build-macos]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')))

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug workflow trigger
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Workflow dispatch input: ${{ github.event.inputs.create_release }}"
        echo "Should run release job: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) }}"
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare individual platform files
      run: |
        # Move individual platform files to root for release
        mv artifacts/password-board-linux/password_board_linux.tar.gz ./

        # Handle Windows file (could be .exe or .zip)
        if [ -f "artifacts/password-board-windows/password_board_windows.exe" ]; then
          mv artifacts/password-board-windows/password_board_windows.exe ./
        elif [ -f "artifacts/password-board-windows/password_board_windows.zip" ]; then
          mv artifacts/password-board-windows/password_board_windows.zip ./
        fi

        mv artifacts/password-board-macos/password_board_macos.zip ./

        # List files to verify
        echo "Files prepared for release:"
        ls -la *.tar.gz *.zip 2>/dev/null || echo "No tar.gz or zip files found"
        ls -la *.exe 2>/dev/null || echo "No exe files found"

    - name: Handle versioning strategy
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          echo "Using existing tag: $GITHUB_REF"
          VERSION_TAG=$GITHUB_REF
        else
          echo "No tag found, will create one from pubspec version"
          VERSION_TAG="v${VERSION}"
          echo "Will create tag: $VERSION_TAG"
        fi
        echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
      env:
        VERSION: ${{ needs.extract-version.outputs.version }}
      id: version_handler

    - name: Create tag if needed
      if: steps.version_handler.outputs.version_tag != '' && !startsWith(github.ref, 'refs/tags/')
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.version_handler.outputs.version_tag }}
        git push origin ${{ steps.version_handler.outputs.version_tag }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check if release exists
      id: check_release
      run: |
        if gh release view ${{ steps.version_handler.outputs.version_tag }} >/dev/null 2>&1; then
          echo "Release ${{ steps.version_handler.outputs.version_tag }} already exists"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Release ${{ steps.version_handler.outputs.version_tag }} does not exist"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      if: steps.check_release.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version_handler.outputs.version_tag }}
        name: Password Board ${{ steps.version_handler.outputs.version_tag }}
        draft: true
        prerelease: false
        body: |
          ## Password Board ${{ steps.version_handler.outputs.version_tag }}

          Cross-platform desktop application for secure password management.

          ### Downloads
          - **🐧 Linux**: `password_board_linux.tar.gz` (tar.gz archive)
          - **🪟 Windows**: `password_board_windows.exe` or `password_board_windows.zip` (executable or archive)
          - **🍎 macOS**: `password_board_macos.zip` (zip archive containing .app)

          ### Installation Instructions

          **🐧 Linux:**
          ```bash
          tar -xzf password_board_linux.tar.gz
          cd password_board
          ./password_board
          ```

          **🪟 Windows:**
          ```cmd
          # If you downloaded .exe: Just run password_board_windows.exe
          # If you downloaded .zip: Extract and run password_board.exe
          ```

          **🍎 macOS:**
          ```bash
          # Extract password_board_macos.zip
          # Run passboard_app.app
          ```

          ### Features
          - 🔐 Secure password management for MSPs
          - 📋 One-click copy functionality
          - 🔍 Advanced search and filtering
          - 📊 Client organization
          - 🎨 Modern Material Design 3 UI
          - 🔄 Cross-platform compatibility
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload release assets
      run: |
        echo "Available files for upload:"
        ls -la *.tar.gz *.zip *.exe 2>/dev/null || echo "No build artifacts found"

        echo "Uploading assets to release ${{ steps.version_handler.outputs.version_tag }}"

        # Upload Linux build
        if [ -f "password_board_linux.tar.gz" ]; then
          echo "Uploading Linux build..."
          gh release upload ${{ steps.version_handler.outputs.version_tag }} password_board_linux.tar.gz --clobber
        else
          echo "Warning: Linux build not found"
        fi

        # Upload Windows file (could be .exe or .zip)
        if [ -f "password_board_windows.exe" ]; then
          echo "Uploading Windows exe..."
          gh release upload ${{ steps.version_handler.outputs.version_tag }} password_board_windows.exe --clobber
        elif [ -f "password_board_windows.zip" ]; then
          echo "Uploading Windows zip..."
          gh release upload ${{ steps.version_handler.outputs.version_tag }} password_board_windows.zip --clobber
        else
          echo "Warning: Windows build not found"
        fi

        # Upload macOS build
        if [ -f "password_board_macos.zip" ]; then
          echo "Uploading macOS build..."
          gh release upload ${{ steps.version_handler.outputs.version_tag }} password_board_macos.zip --clobber
        else
          echo "Warning: macOS build not found"
        fi

        echo "Release upload complete"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


